<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="3315px" preserveAspectRatio="none" style="width:1559px;height:3315px;" version="1.1" viewBox="0 0 1559 3315" width="1559px" zoomAndPan="magnify"><defs><filter height="300%" id="f1qsabjdtrjfl2" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="60" x="749.5" y="22.9951">登入流程</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="0" x="782" y="39.292"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="385" x2="385" y1="84.8906" y2="3275.5547"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="792.5" x2="792.5" y1="84.8906" y2="3275.5547"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="924.5" x2="924.5" y1="84.8906" y2="3275.5547"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1305.5" x2="1305.5" y1="84.8906" y2="3275.5547"/><rect fill="#FEFECE" filter="url(#f1qsabjdtrjfl2)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="56" x="355" y="49.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="362" y="69.5889">浏览器</text><rect fill="#FEFECE" filter="url(#f1qsabjdtrjfl2)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="56" x="355" y="3274.5547"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="362" y="3294.5498">浏览器</text><rect fill="#FEFECE" filter="url(#f1qsabjdtrjfl2)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="45" x="768.5" y="49.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="31" x="775.5" y="69.5889">uum</text><rect fill="#FEFECE" filter="url(#f1qsabjdtrjfl2)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="45" x="768.5" y="3274.5547"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="31" x="775.5" y="3294.5498">uum</text><rect fill="#FEFECE" filter="url(#f1qsabjdtrjfl2)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="39" x="903.5" y="49.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="25" x="910.5" y="69.5889">sso</text><rect fill="#FEFECE" filter="url(#f1qsabjdtrjfl2)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="39" x="903.5" y="3274.5547"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="25" x="910.5" y="3294.5498">sso</text><rect fill="#FEFECE" filter="url(#f1qsabjdtrjfl2)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="61" x="1273.5" y="49.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="47" x="1280.5" y="69.5889">Dubbo</text><rect fill="#FEFECE" filter="url(#f1qsabjdtrjfl2)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="61" x="1273.5" y="3274.5547"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="47" x="1280.5" y="3294.5498">Dubbo</text><polygon fill="#A80036" points="781,127.1563,791,131.1563,781,135.1563,785,131.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="385" x2="787" y1="131.1563" y2="131.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="392" y="118.5239">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="405" y="110.9575">第一次访问</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="409" y="126.0903">https://uum.com</text><path d="M705,144.1563 L705,184.1563 L876,184.1563 L876,154.1563 L866,144.1563 L705,144.1563 " fill="#FBFB77" filter="url(#f1qsabjdtrjfl2)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M866,144.1563 L866,154.1563 L876,154.1563 L866,144.1563 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="711" y="161.2231">spring-mvc.xml中配置了</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="711" y="176.356">&lt;mvc:view-controller&gt;</text><polygon fill="#A80036" points="396,210.5547,386,214.5547,396,218.5547,392,214.5547" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="390" x2="792" y1="214.5547" y2="214.5547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="402" y="209.4888">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="415" y="209.4888">重定向浏览器</text><polygon fill="#A80036" points="781,254.8203,791,258.8203,781,262.8203,785,258.8203" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="385" x2="787" y1="258.8203" y2="258.8203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="392" y="246.188">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="405" y="238.6216">重发请求</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="409" y="253.7544">https://uum.com/a</text><path d="M672,271.8203 L672,371.8203 L910,371.8203 L910,281.8203 L900,271.8203 L672,271.8203 " fill="#FBFB77" filter="url(#f1qsabjdtrjfl2)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M900,271.8203 L900,281.8203 L910,281.8203 L900,271.8203 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="101" x="678" y="288.8872">被shiroFilter拦截</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="678" y="304.02">1、${adminPath}/cas = cas</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="203" x="678" y="319.1528">2、${adminPath}/login = authc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="678" y="334.2856">3、${adminPath}/logout = logout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="179" x="678" y="349.4185">4、${adminPath}/** = user</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="682" y="364.5513">所以该请求将被UumUserFilter过滤</text><path d="M648,386.6172 L648,426.6172 L934,426.6172 L934,396.6172 L924,386.6172 L648,386.6172 " fill="#FBFB77" filter="url(#f1qsabjdtrjfl2)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M924,386.6172 L924,396.6172 L934,396.6172 L924,386.6172 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="654" y="403.6841">UserFilter中，subject.getPrincipal()==null</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="654" y="418.8169">当前用户无身份信息</text><polygon fill="#A80036" points="396,483.2813,386,487.2813,396,491.2813,392,487.2813" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="390" x2="792" y1="487.2813" y2="487.2813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="402" y="467.0825">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="415" y="451.9497">重定向到</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="37" x="419" y="467.0825">https:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="177" x="456" y="467.0825">//sso.cn/login?service=http:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="633" y="467.0825">//uum.com/a/cas</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="371" x="415" y="482.2153">并向浏览器set_cookie:_sid=...(向浏览器写入shiro session id)</text><polygon fill="#A80036" points="913,512.4141,923,516.4141,913,520.4141,917,516.4141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="385" x2="919" y1="516.4141" y2="516.4141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="392" y="511.3481">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="37" x="405" y="511.3481">https:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="177" x="442" y="511.3481">//sso.cn/login?service=http:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="619" y="511.3481">//uum.com/a/cas</text><path d="M737,529.4141 L737,554.4141 L1109,554.4141 L1109,539.4141 L1099,529.4141 L737,529.4141 " fill="#FBFB77" filter="url(#f1qsabjdtrjfl2)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1099,529.4141 L1099,539.4141 L1109,539.4141 L1099,529.4141 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="351" x="743" y="546.481">UsernamePasswordSmsCredential【用于接收表单数据】</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="925" x2="967" y1="599.8125" y2="599.8125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="967" x2="967" y1="599.8125" y2="612.8125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="926" x2="967" y1="612.8125" y2="612.8125"/><polygon fill="#A80036" points="936,608.8125,926,612.8125,936,616.8125,932,612.8125" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="932" y="587.1802">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="945" y="579.6138">执行登录流程</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="949" y="594.7466">initialFlowSetupAction.doExecute()</text><path d="M650,625.8125 L650,710.8125 L1196,710.8125 L1196,635.8125 L1186,625.8125 L650,625.8125 " fill="#FBFB77" filter="url(#f1qsabjdtrjfl2)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1186,625.8125 L1186,635.8125 L1196,635.8125 L1186,625.8125 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="525" x="656" y="642.8794">WebUtils.putTicketGrantingTicketInScopes:[将TGT放在FlowScope作用域中(第一次无)]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="455" x="660" y="658.0122">WebUtils.putWarningCookie:[将warnCookieValue放在FlowScope作用域中]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="344" x="660" y="673.145">WebUtils.putService:[将service放在FlowScope作用域中]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="406" x="656" y="688.2778">(将TGT，warnCookieValue和service放在RequestContext作用域中,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="220" x="656" y="703.4106">以便在登入流程中的state中进行判断)</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="925" x2="967" y1="741.6094" y2="741.6094"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="967" x2="967" y1="741.6094" y2="754.6094"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="926" x2="967" y1="754.6094" y2="754.6094"/><polygon fill="#A80036" points="936,750.6094,926,754.6094,936,758.6094,932,754.6094" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="932" y="736.5435">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="229" x="945" y="736.5435">ticketGrantingTicketCheck，验证TGT</text><path d="M788,767.6094 L788,822.6094 L1057,822.6094 L1057,777.6094 L1047,767.6094 L788,767.6094 " fill="#FBFB77" filter="url(#f1qsabjdtrjfl2)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1047,767.6094 L1047,777.6094 L1057,777.6094 L1047,767.6094 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="248" x="794" y="784.6763">不存在：进入gatewayRequestCheck流程</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="798" y="799.8091">无效：进入terminateSession流程</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="200" x="798" y="814.9419">有效：进入hasServiceCheck流程</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="925" x2="967" y1="853.1406" y2="853.1406"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="967" x2="967" y1="853.1406" y2="866.1406"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="926" x2="967" y1="866.1406" y2="866.1406"/><polygon fill="#A80036" points="936,862.1406,926,866.1406,936,870.1406,932,866.1406" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="932" y="848.0747">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183" x="945" y="848.0747">gatewayRequestCheck流程：</text><path d="M701,879.1406 L701,919.1406 L1144,919.1406 L1144,889.1406 L1134,879.1406 L701,879.1406 " fill="#FBFB77" filter="url(#f1qsabjdtrjfl2)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1134,879.1406 L1134,889.1406 L1144,889.1406 L1134,879.1406 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="422" x="707" y="896.2075">有gateway&amp;service:则进入gatewayServicesManagementCheck流程</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="260" x="711" y="911.3403">否则进入：serviceAuthorizationCheck流程</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="925" x2="967" y1="949.5391" y2="949.5391"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="967" x2="967" y1="949.5391" y2="962.5391"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="926" x2="967" y1="962.5391" y2="962.5391"/><polygon fill="#A80036" points="936,958.5391,926,962.5391,936,966.5391,932,962.5391" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="932" y="944.4731">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="945" y="944.4731">serviceAuthorizationCheck流程:[验证service]</text><path d="M625,975.5391 L625,1000.5391 L1221,1000.5391 L1221,985.5391 L1211,975.5391 L625,975.5391 " fill="#FBFB77" filter="url(#f1qsabjdtrjfl2)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1211,975.5391 L1211,985.5391 L1221,985.5391 L1211,975.5391 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="575" x="631" y="992.606">要做的就是判断RequestContext作用域中是否存在service，如果service存在，查寻service的注册</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="925" x2="967" y1="1030.8047" y2="1030.8047"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="967" x2="967" y1="1030.8047" y2="1043.8047"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="926" x2="967" y1="1043.8047" y2="1043.8047"/><polygon fill="#A80036" points="936,1039.8047,926,1043.8047,936,1047.8047,932,1043.8047" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="932" y="1025.7388">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="954" y="1025.7388">进入generateLoginTicket流程：</text><path d="M653,1056.8047 L653,1111.8047 L1193,1111.8047 L1193,1066.8047 L1183,1056.8047 L653,1056.8047 " fill="#FBFB77" filter="url(#f1qsabjdtrjfl2)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1183,1056.8047 L1183,1066.8047 L1193,1066.8047 L1183,1056.8047 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="442" x="659" y="1073.8716">generateLoginTicketAction.generate(flowRequestContext)，生成token</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="519" x="659" y="1089.0044">生成以LT作为字首的loginTicket（例：LT-2-pfDmbEHfX2OkS0swLtDd7iDwmzlhsn），</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="469" x="659" y="1104.1372">并且把loginTicket放到RequestContext作用域中（LT只作为登入时使用的票据）</text><path d="M755,1126.2031 L755,1181.2031 L1090,1181.2031 L1090,1136.2031 L1080,1126.2031 L755,1126.2031 " fill="#FBFB77" filter="url(#f1qsabjdtrjfl2)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1080,1126.2031 L1080,1136.2031 L1090,1136.2031 L1080,1126.2031 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="761" y="1143.27">login token生成规则：</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="896" y="1143.27">*</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="7" x="903" y="1143.27">*</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="314" x="761" y="1158.4028">DefaultUniqueTicketIdGenerator.getNewTicketId()</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="761" y="1173.5356">LT-AtomicLong-随机数</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="925" x2="967" y1="1211.7344" y2="1211.7344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="967" x2="967" y1="1211.7344" y2="1224.7344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="926" x2="967" y1="1224.7344" y2="1224.7344"/><polygon fill="#A80036" points="936,1220.7344,926,1224.7344,936,1228.7344,932,1224.7344" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="932" y="1206.6685">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="954" y="1206.6685">进入loginMethod流程</text><polygon fill="#A80036" points="396,1265,386,1269,396,1273,392,1269" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="390" x2="924" y1="1269" y2="1269"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="402" y="1256.3677">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="424" y="1248.8013">loginMethod流程</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="490" x="428" y="1263.9341">进入登录页面，将set_cookie:JSESSIONID=...(cas server的session id写入浏览器)</text><polygon fill="#A80036" points="913,1294.1328,923,1298.1328,913,1302.1328,917,1298.1328" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="385" x2="919" y1="1298.1328" y2="1298.1328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="392" y="1293.0669">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="221" x="414" y="1293.0669">登录界面：输入用户名密码，点击登录</text><path d="M8,1311.1328 L8,1381.1328 L758,1381.1328 L758,1321.1328 L748,1311.1328 L8,1311.1328 " fill="#FBFB77" filter="url(#f1qsabjdtrjfl2)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M748,1311.1328 L748,1321.1328 L758,1321.1328 L748,1311.1328 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="37" x="14" y="1328.1997">https:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="597" x="51" y="1328.1997">//sso.cn/login;jsessionid=194B34537E3DBCB5366188CBBFF70EA2332232323?service=https:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="648" y="1328.1997">//uum.com/cas</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="224" x="14" y="1343.3325">lt=...[logint token:作为登录时的票据]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85" x="14" y="1358.4653">execution=...</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="14" y="1373.5981">_eventId=...</text><polygon fill="#A80036" points="1294,1407.7969,1304,1411.7969,1294,1415.7969,1298,1411.7969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="925" x2="1300" y1="1411.7969" y2="1411.7969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="932" y="1406.731">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="307" x="954" y="1406.731">authenticationViaFormAction.validatorCaptcha()</text><path d="M719,1424.7969 L719,1509.7969 L1126,1509.7969 L1126,1434.7969 L1116,1424.7969 L719,1424.7969 " fill="#FBFB77" filter="url(#f1qsabjdtrjfl2)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1116,1424.7969 L1116,1434.7969 L1126,1434.7969 L1116,1424.7969 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="337" x="725" y="1441.8638">SmsAuthenticationViaFormAction.validatorCaptcha()</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="725" y="1456.9966">一.验证输入手机号与用户手机号是否一致</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="725" y="1472.1294">二.验证验证码与redis验证码是否一致</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="725" y="1487.2622">调用的相关UUM服务</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="386" x="725" y="1502.395">example.createCriteria().andLoginNameEqualTo(loginName)</text><path d="M1165,1524.4609 L1165,1564.4609 L1443,1564.4609 L1443,1534.4609 L1433,1524.4609 L1165,1524.4609 " fill="#FBFB77" filter="url(#f1qsabjdtrjfl2)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1433,1524.4609 L1433,1534.4609 L1443,1534.4609 L1433,1524.4609 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="247" x="1171" y="1541.5278">根据用户名，获取与登录名一致的用户数据</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="1171" y="1556.6606">userService.selectByExample(example):</text><polygon fill="#A80036" points="936,1590.8594,926,1594.8594,936,1598.8594,932,1594.8594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="930" x2="1305" y1="1594.8594" y2="1594.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="942" y="1589.7935">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="964" y="1589.7935">返回用户数据</text><path d="M899,1607.8594 L899,1632.8594 L946,1632.8594 L946,1617.8594 L936,1607.8594 L899,1607.8594 " fill="#FBFB77" filter="url(#f1qsabjdtrjfl2)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M936,1607.8594 L936,1617.8594 L946,1617.8594 L936,1607.8594 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="26" x="905" y="1624.9263">验证</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="925" x2="967" y1="1678.2578" y2="1678.2578"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="967" x2="967" y1="1678.2578" y2="1691.2578"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="926" x2="967" y1="1691.2578" y2="1691.2578"/><polygon fill="#A80036" points="936,1687.2578,926,1691.2578,936,1695.2578,932,1691.2578" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="932" y="1665.6255">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="954" y="1658.0591">验证通过，则进入 realSubmit流程</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="243" x="958" y="1673.1919">authenticationViaFormAction.submit()</text><path d="M692,1704.2578 L692,1850.2578 L1153,1850.2578 L1153,1714.2578 L1143,1704.2578 L692,1704.2578 " fill="#FBFB77" filter="url(#f1qsabjdtrjfl2)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1143,1704.2578 L1143,1714.2578 L1153,1714.2578 L1143,1704.2578 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="698" y="1721.3247">cas-servlet.xml</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="698" y="1736.4575">1.&lt;bean id="authenticationViaFormAction"&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="322" x="706" y="1751.5903">&lt;property name="centralAuthenticationService"&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="440" x="698" y="1766.7231">2.&lt;bean id="centralAuthenticationService"&gt;[applicationcontext.xml]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="350" x="710" y="1781.856">c:authenticationManager-ref="authenticationManager"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="428" x="698" y="1796.9888">3.&lt;bean id="authenticationManager"&gt;[deployerconfigcontext.xml]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="316" x="706" y="1812.1216">&lt;entry key-ref="uumScfAuthenticationHandler"&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="294" x="698" y="1827.2544">4.&lt;bean id="uumScfAuthenticationHandler"&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="706" y="1842.3872">使用 UUM SCF 方式连接数据库进行用户名、密码认证</text><path d="M609,1864.4531 L609,1904.4531 L1237,1904.4531 L1237,1874.4531 L1227,1864.4531 L609,1864.4531 " fill="#FBFB77" filter="url(#f1qsabjdtrjfl2)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1227,1864.4531 L1227,1874.4531 L1237,1874.4531 L1227,1864.4531 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="615" y="1881.52">AuthenticationViaFormAction.submit()方法</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="607" x="615" y="1896.6528">handler.authenticate[UumScfAuthenticationHandler.authenticateUsernamePasswordInternal()]</text><polygon fill="#A80036" points="1294,1930.8516,1304,1934.8516,1294,1938.8516,1298,1934.8516" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="925" x2="1300" y1="1934.8516" y2="1934.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="932" y="1929.7856">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="252" x="954" y="1929.7856">这个是主要登录流程，调用的相关UUM服务</text><path d="M1061,1947.8516 L1061,2138.8516 L1547,2138.8516 L1547,1957.8516 L1537,1947.8516 L1061,1947.8516 " fill="#FBFB77" filter="url(#f1qsabjdtrjfl2)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1537,1947.8516 L1537,1957.8516 L1547,1957.8516 L1537,1947.8516 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="1067" y="1964.9185">一、微信公众号免密登录：</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="302" x="1083" y="1980.0513">userService.loginWithWeixin(username, openid)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="1083" y="1995.1841">logService.save(log):登录成功后，异步写入日志信息</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1071" y="2010.3169"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="1067" y="2025.4497">二、微信扫描登录</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="1083" y="2040.5825">userService.loginWithUserId(userId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="1083" y="2055.7153">logService.save(log):登录成功后，异步写入日志信息</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1071" y="2070.8481"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="1067" y="2085.981">三、用户名密码登录：</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="449" x="1083" y="2101.1138">userService.login(username, decodedPassword)，获取用户信息[inpass]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="369" x="1083" y="2116.2466">userLoginLogService.save(userLoginLog);写入用户登录信息</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="1083" y="2131.3794">logService.save(log):登录成功后，异步写入日志信息</text><polygon fill="#A80036" points="936,2165.5781,926,2169.5781,936,2173.5781,932,2169.5781" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="930" x2="1305" y1="2169.5781" y2="2169.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="942" y="2164.5122">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="964" y="2164.5122">返回数据</text><path d="M652,2182.5781 L652,2252.5781 L1194,2252.5781 L1194,2192.5781 L1184,2182.5781 L652,2182.5781 " fill="#FBFB77" filter="url(#f1qsabjdtrjfl2)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1184,2182.5781 L1184,2192.5781 L1194,2192.5781 L1184,2182.5781 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="658" y="2199.645">AuthenticationViaFormAction.submit()方法</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="313" x="658" y="2214.7778">判断FlowScope和request中的loginTicket是否相同。</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="492" x="658" y="2229.9106">如果不同跳转到错误页面，如果相同，則根据使用者凭证生成TGT（登入成功票据），</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="521" x="658" y="2245.0435">并放到requestScope作用域中，同時把TGT存放至cas server的cache&lt;ticketId,TGT&gt;中</text><path d="M912,2267.1094 L912,2277.1094 L933,2277.1094 L933,2277.1094 L923,2267.1094 L912,2267.1094 " fill="#FBFB77" filter="url(#f1qsabjdtrjfl2)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M923,2267.1094 L923,2277.1094 L933,2277.1094 L923,2267.1094 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M678,2291.1094 L678,2406.1094 L1168,2406.1094 L1168,2301.1094 L1158,2291.1094 L678,2291.1094 " fill="#FBFB77" filter="url(#f1qsabjdtrjfl2)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1158,2291.1094 L1158,2301.1094 L1168,2301.1094 L1158,2291.1094 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="684" y="2308.1763">TGT生成规则：</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="469" x="684" y="2323.3091">TicketGrantingTicket ticketGrantingTicket = new TicketGrantingTicketImpl(</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="684" y="2338.4419">this.ticketGrantingTicketUniqueTicketIdGenerator</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="385" x="684" y="2353.5747">.getNewTicketId(TicketGrantingTicket.PREFIX),authentication,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="262" x="684" y="2368.7075">this.ticketGrantingTicketExpirationPolicy);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="421" x="684" y="2383.8403">生成TGT后，需要this.ticketRegistry.addTicket(ticketGrantingTicket);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="266" x="684" y="2398.9731">因此，保存TGT的地方可以自定义为Redis存储</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="925" x2="967" y1="2437.1719" y2="2437.1719"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="967" x2="967" y1="2437.1719" y2="2450.1719"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="926" x2="967" y1="2450.1719" y2="2450.1719"/><polygon fill="#A80036" points="936,2446.1719,926,2450.1719,936,2454.1719,932,2450.1719" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="932" y="2432.106">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="212" x="954" y="2432.106">进入sendTicketGrantingTicket流程</text><path d="M741,2463.1719 L741,2488.1719 L1105,2488.1719 L1105,2473.1719 L1095,2463.1719 L741,2463.1719 " fill="#FBFB77" filter="url(#f1qsabjdtrjfl2)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1095,2463.1719 L1095,2473.1719 L1105,2473.1719 L1095,2463.1719 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="343" x="747" y="2480.2388">获取TGT，并根据TGT生成cookie（TGC）新增到response</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="925" x2="967" y1="2518.4375" y2="2518.4375"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="967" x2="967" y1="2518.4375" y2="2531.4375"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="926" x2="967" y1="2531.4375" y2="2531.4375"/><polygon fill="#A80036" points="936,2527.4375,926,2531.4375,936,2535.4375,932,2531.4375" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="932" y="2513.3716">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="345" x="954" y="2513.3716">进入serviceCheck流程，判断flowscope.servcice是否为空</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="925" x2="967" y1="2575.7031" y2="2575.7031"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="967" x2="967" y1="2575.7031" y2="2588.7031"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="926" x2="967" y1="2588.7031" y2="2588.7031"/><polygon fill="#A80036" points="936,2584.7031,926,2588.7031,936,2592.7031,932,2588.7031" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="932" y="2563.0708">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="954" y="2555.5044">进入generateServiceTicket流程</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="954" y="2570.6372">GenerateServiceTicketAction.doExecute()</text><path d="M599,2601.7031 L599,2656.7031 L1246,2656.7031 L1246,2611.7031 L1236,2601.7031 L599,2601.7031 " fill="#FBFB77" filter="url(#f1qsabjdtrjfl2)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1236,2601.7031 L1236,2611.7031 L1246,2611.7031 L1236,2601.7031 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="151" x="605" y="2618.77">Service ticket生成规则：</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="431" x="605" y="2633.9028">获取service和TGT，并根据service和TGT生成以ST为字首的serviceTicket</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="626" x="605" y="2649.0356">（例：ST-2-97kwhcdrBW97ynpBbZH5-cas01.example.org），并把serviceTicket放到requestScope中</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="925" x2="967" y1="2687.2344" y2="2687.2344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="967" x2="967" y1="2687.2344" y2="2700.2344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="926" x2="967" y1="2700.2344" y2="2700.2344"/><polygon fill="#A80036" points="936,2696.2344,926,2700.2344,936,2704.2344,932,2700.2344" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="932" y="2682.1685">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="101" x="954" y="2682.1685">进入redirect流程</text><polygon fill="#A80036" points="396,2755.6328,386,2759.6328,396,2763.6328,392,2759.6328" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="390" x2="924" y1="2759.6328" y2="2759.6328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="402" y="2739.4341">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="269" x="424" y="2724.3013">重定向：https:////uum.com/a/cas?ticket=...</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="282" x="428" y="2739.4341">set-cookie: TGC=...(向浏览器返回TGC cookie)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="424" y="2754.5669">在URL中携带service token</text><polygon fill="#A80036" points="781,2784.7656,791,2788.7656,781,2792.7656,785,2788.7656" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="385" x2="787" y1="2788.7656" y2="2788.7656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="392" y="2783.6997">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="414" y="2783.6997">https:////uum.com/a/cas?ticket=...</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="793" x2="835" y1="2817.8984" y2="2817.8984"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="835" x2="835" y1="2817.8984" y2="2830.8984"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="794" x2="835" y1="2830.8984" y2="2830.8984"/><polygon fill="#A80036" points="804,2826.8984,794,2830.8984,804,2834.8984,800,2830.8984" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="800" y="2812.8325">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="822" y="2812.8325">认证授权过程</text><path d="M424,2843.8984 L424,2913.8984 L1157,2913.8984 L1157,2853.8984 L1147,2843.8984 L424,2843.8984 " fill="#FBFB77" filter="url(#f1qsabjdtrjfl2)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1147,2843.8984 L1147,2853.8984 L1157,2853.8984 L1147,2843.8984 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="430" y="2860.9653">进行登录</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="496" x="430" y="2876.0981">CAS客戶端的AuthenticationFilter过滤器登录：AuthenticatingFilter.executLogin()</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="712" x="430" y="2891.231">由于session中获取名为_const_cas_assertion_的assertion物件不存在，但是request有ticket，所以进入到下一个过滤器</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="483" x="430" y="2906.3638">TicketValidationFilter过滤器的validate方法通过httpClient服务CAS server服器端</text><path d="M491,2928.4297 L491,3013.4297 L1091,3013.4297 L1091,2938.4297 L1081,2928.4297 L491,2928.4297 " fill="#FBFB77" filter="url(#f1qsabjdtrjfl2)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1081,2928.4297 L1081,2938.4297 L1091,2938.4297 L1081,2928.4297 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="497" y="2945.4966">执行登录：DelegatingSubject.login()</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="279" x="497" y="2960.6294">获取授权信息：DefaultSecurityManager.login</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="229" x="497" y="2975.7622">授权：info = doAuthenticate(token);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="497" y="2990.895">被UumCasFilter拦截</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="579" x="497" y="3006.0278">缓存 CAS Service Ticket 与 Shiro Service ID 的映射关系：cache.put(serviceTicket, sessionId);</text><polygon fill="#A80036" points="781,3055.3594,791,3059.3594,781,3063.3594,785,3059.3594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="385" x2="787" y1="3059.3594" y2="3059.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="392" y="3046.7271">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="414" y="3039.1606">重定向</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="414" y="3054.2935">https://uum.com/a</text><path d="M672,3072.3594 L672,3172.3594 L910,3172.3594 L910,3082.3594 L900,3072.3594 L672,3072.3594 " fill="#FBFB77" filter="url(#f1qsabjdtrjfl2)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M900,3072.3594 L900,3082.3594 L910,3082.3594 L900,3072.3594 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="101" x="678" y="3089.4263">被shiroFilter拦截</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="678" y="3104.5591">1、${adminPath}/cas = cas</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="203" x="678" y="3119.6919">2、${adminPath}/login = authc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="678" y="3134.8247">3、${adminPath}/logout = logout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="179" x="678" y="3149.9575">4、${adminPath}/** = user</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="682" y="3165.0903">所以该请求将被UumUserFilter过滤</text><path d="M648,3187.1563 L648,3227.1563 L934,3227.1563 L934,3197.1563 L924,3187.1563 L648,3187.1563 " fill="#FBFB77" filter="url(#f1qsabjdtrjfl2)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M924,3187.1563 L924,3197.1563 L934,3197.1563 L924,3187.1563 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="654" y="3204.2231">UserFilter中，subject.getPrincipal()==null</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="654" y="3219.356">当前用户已经有身份信息，有权访问</text><polygon fill="#A80036" points="396,3253.5547,386,3257.5547,396,3261.5547,392,3257.5547" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="390" x2="792" y1="3257.5547" y2="3257.5547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="402" y="3252.4888">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="424" y="3252.4888">返回数据</text><!--
@startuml
Title: 登入流程\n
autonumber
浏览器 -> uum: 第一次访问\n https://uum.com
note over uum:spring-mvc.xml中配置了\n<mvc:view-controller>
uum - -> 浏览器: 重定向浏览器
浏览器 -> uum: 重发请求\n https://uum.com/a
note over uum:被shiroFilter拦截\n1、${adminPath}/cas = cas\n2、${adminPath}/login = authc\n3、${adminPath}/logout = logout\n4、${adminPath}/** = user\n 所以该请求将被UumUserFilter过滤
note over uum:UserFilter中，subject.getPrincipal()==null\n当前用户无身份信息
uum - -> 浏览器: 重定向到\n https:////sso.cn/login?service=http:////uum.com/a/cas\n并向浏览器set_cookie:_sid=...(向浏览器写入shiro session id)
浏览器 -> sso: https:////sso.cn/login?service=http:////uum.com/a/cas
note over sso:UsernamePasswordSmsCredential【用于接收表单数据】
sso - -> sso: 执行登录流程\n initialFlowSetupAction.doExecute()
note over sso:WebUtils.putTicketGrantingTicketInScopes:[将TGT放在FlowScope作用域中(第一次无)]\n WebUtils.putWarningCookie:[将warnCookieValue放在FlowScope作用域中]\n WebUtils.putService:[将service放在FlowScope作用域中]\n(将TGT，warnCookieValue和service放在RequestContext作用域中,\n以便在登入流程中的state中进行判断)
sso - -> sso: ticketGrantingTicketCheck，验证TGT
note over sso:不存在：进入gatewayRequestCheck流程\n 无效：进入terminateSession流程\n 有效：进入hasServiceCheck流程
sso - -> sso: gatewayRequestCheck流程：
note over sso:有gateway&service:则进入gatewayServicesManagementCheck流程\n 否则进入：serviceAuthorizationCheck流程
sso - -> sso: serviceAuthorizationCheck流程:[验证service]
note over sso:要做的就是判断RequestContext作用域中是否存在service，如果service存在，查寻service的注册
sso - -> sso: 进入generateLoginTicket流程：
note over sso:generateLoginTicketAction.generate(flowRequestContext)，生成token\n生成以LT作为字首的loginTicket（例：LT-2-pfDmbEHfX2OkS0swLtDd7iDwmzlhsn），\n并且把loginTicket放到RequestContext作用域中（LT只作为登入时使用的票据）
note over sso:login token生成规则：******\nDefaultUniqueTicketIdGenerator.getNewTicketId()\nLT-AtomicLong-随机数
sso - -> sso:进入loginMethod流程
sso - -> 浏览器: loginMethod流程\n 进入登录页面，将set_cookie:JSESSIONID=...(cas server的session id写入浏览器)
浏览器 -> sso: 登录界面：输入用户名密码，点击登录
note over 浏览器:https:////sso.cn/login;jsessionid=194B34537E3DBCB5366188CBBFF70EA2332232323?service=https:////uum.com/cas\nlt=...[logint token:作为登录时的票据]\nexecution=...\n_eventId=...
sso -> Dubbo:authenticationViaFormAction.validatorCaptcha()
note over sso:SmsAuthenticationViaFormAction.validatorCaptcha()\n一.验证输入手机号与用户手机号是否一致\n二.验证验证码与redis验证码是否一致\n调用的相关UUM服务\nexample.createCriteria().andLoginNameEqualTo(loginName)
note over Dubbo:根据用户名，获取与登录名一致的用户数据\nuserService.selectByExample(example):
Dubbo - -> sso:返回用户数据
note over sso:验证
sso - -> sso: 验证通过，则进入 realSubmit流程\n authenticationViaFormAction.submit()
note over sso: cas-servlet.xml\n1.<bean id="authenticationViaFormAction">\n  <property name="centralAuthenticationService">\n2.<bean id="centralAuthenticationService">[applicationcontext.xml]\n   c:authenticationManager-ref="authenticationManager"\n3.<bean id="authenticationManager">[deployerconfigcontext.xml]\n  <entry key-ref="uumScfAuthenticationHandler">\n4.<bean id="uumScfAuthenticationHandler">\n  使用 UUM SCF 方式连接数据库进行用户名、密码认证
note over sso:AuthenticationViaFormAction.submit()方法\nhandler.authenticate[UumScfAuthenticationHandler.authenticateUsernamePasswordInternal()]

sso -> Dubbo:这个是主要登录流程，调用的相关UUM服务
note over Dubbo: 一、微信公众号免密登录：\n    userService.loginWithWeixin(username, openid)\n    logService.save(log):登录成功后，异步写入日志信息 \n\n二、微信扫描登录\n    userService.loginWithUserId(userId)\n    logService.save(log):登录成功后，异步写入日志信息 \n\n三、用户名密码登录：\n    userService.login(username, decodedPassword)，获取用户信息[inpass]\n    userLoginLogService.save(userLoginLog);写入用户登录信息\n    logService.save(log):登录成功后，异步写入日志信息
Dubbo - -> sso: 返回数据
note over sso:AuthenticationViaFormAction.submit()方法\n判断FlowScope和request中的loginTicket是否相同。\n如果不同跳转到错误页面，如果相同，則根据使用者凭证生成TGT（登入成功票据），\n并放到requestScope作用域中，同時把TGT存放至cas server的cache<ticketId,TGT>中
note over sso:
note over sso:TGT生成规则：\nTicketGrantingTicket ticketGrantingTicket = new TicketGrantingTicketImpl(\nthis.ticketGrantingTicketUniqueTicketIdGenerator\n.getNewTicketId(TicketGrantingTicket.PREFIX),authentication, \nthis.ticketGrantingTicketExpirationPolicy);\n生成TGT后，需要this.ticketRegistry.addTicket(ticketGrantingTicket);\n因此，保存TGT的地方可以自定义为Redis存储
sso - -> sso:进入sendTicketGrantingTicket流程
note over sso:获取TGT，并根据TGT生成cookie（TGC）新增到response
sso - -> sso:进入serviceCheck流程，判断flowscope.servcice是否为空
sso - -> sso:进入generateServiceTicket流程\nGenerateServiceTicketAction.doExecute()
note over sso:Service ticket生成规则：\n获取service和TGT，并根据service和TGT生成以ST为字首的serviceTicket\n（例：ST-2-97kwhcdrBW97ynpBbZH5-cas01.example.org），并把serviceTicket放到requestScope中
sso - -> sso:进入redirect流程
sso - -> 浏览器: 重定向：https:////uum.com/a/cas?ticket=... \n set-cookie: TGC=...(向浏览器返回TGC cookie)\n在URL中携带service token
浏览器 -> uum: https:////uum.com/a/cas?ticket=...
uum -> uum:认证授权过程
note over uum:进行登录\nCAS客戶端的AuthenticationFilter过滤器登录：AuthenticatingFilter.executLogin()\n由于session中获取名为_const_cas_assertion_的assertion物件不存在，但是request有ticket，所以进入到下一个过滤器\nTicketValidationFilter过滤器的validate方法通过httpClient服务CAS server服器端
note over uum:执行登录：DelegatingSubject.login()\n获取授权信息：DefaultSecurityManager.login\n授权：info = doAuthenticate(token);\n被UumCasFilter拦截\n缓存 CAS Service Ticket 与 Shiro Service ID 的映射关系：cache.put(serviceTicket, sessionId);
浏览器 -> uum: 重定向\nhttps://uum.com/a
note over uum:被shiroFilter拦截\n1、${adminPath}/cas = cas\n2、${adminPath}/login = authc\n3、${adminPath}/logout = logout\n4、${adminPath}/** = user\n 所以该请求将被UumUserFilter过滤
note over uum:UserFilter中，subject.getPrincipal()==null\n当前用户已经有身份信息，有权访问
uum - -> 浏览器: 返回数据
@enduml

PlantUML version 1.2019.08(Sat Jul 13 19:25:14 UTC 2019)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.7.0_25-b15
Operating System: Linux
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>