<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="760px" preserveAspectRatio="none" style="width:1334px;height:760px;" version="1.1" viewBox="0 0 1334 760" width="1334px" zoomAndPan="magnify"><defs><filter height="300%" id="fhxgr4n07kenp" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="60" x="639.75" y="22.9951">登出流程</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="0" x="672.25" y="39.292"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="38" x2="38" y1="84.8906" y2="720.6094"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="102" x2="102" y1="84.8906" y2="720.6094"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="430" x2="430" y1="84.8906" y2="720.6094"/><rect fill="#FEFECE" filter="url(#fhxgr4n07kenp)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="56" x="8" y="49.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="15" y="69.5889">浏览器</text><rect fill="#FEFECE" filter="url(#fhxgr4n07kenp)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="56" x="8" y="719.6094"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="15" y="739.6045">浏览器</text><rect fill="#FEFECE" filter="url(#fhxgr4n07kenp)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="45" x="78" y="49.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="31" x="85" y="69.5889">uum</text><rect fill="#FEFECE" filter="url(#fhxgr4n07kenp)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="45" x="78" y="719.6094"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="31" x="85" y="739.6045">uum</text><rect fill="#FEFECE" filter="url(#fhxgr4n07kenp)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="39" x="409" y="49.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="25" x="416" y="69.5889">sso</text><rect fill="#FEFECE" filter="url(#fhxgr4n07kenp)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="39" x="409" y="719.6094"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="25" x="416" y="739.6045">sso</text><polygon fill="#A80036" points="90.5,112.0234,100.5,116.0234,90.5,120.0234,94.5,116.0234" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="38" x2="96.5" y1="116.0234" y2="116.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="45" y="110.9575">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="26" x="58" y="110.9575">退出</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="102.5" x2="144.5" y1="190.5547" y2="190.5547"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="144.5" x2="144.5" y1="190.5547" y2="203.5547"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="103.5" x2="144.5" y1="203.5547" y2="203.5547"/><polygon fill="#A80036" points="113.5,199.5547,103.5,203.5547,113.5,207.5547,109.5,203.5547" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="109.5" y="162.7896">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="122.5" y="140.0903">CasSingleSignOutFilter</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="122.5" y="155.2231">根据ST查询session 并删除本地缓存的session</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="301" x="122.5" y="170.356">存储类HashMapBackedSessionMappingStorage</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="122.5" y="185.4888">清除当前session的所有相关信息</text><polygon fill="#A80036" points="418.5,228.6875,428.5,232.6875,418.5,236.6875,422.5,232.6875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="102.5" x2="424.5" y1="232.6875" y2="232.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="109.5" y="227.6216">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="37" x="122.5" y="227.6216">https:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="187" x="159.5" y="227.6216">//sso.cn/logout?service=http:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="346.5" y="227.6216">//uum.cn</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="430.5" x2="472.5" y1="290.5859" y2="290.5859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="472.5" x2="472.5" y1="290.5859" y2="303.5859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="431.5" x2="472.5" y1="303.5859" y2="303.5859"/><polygon fill="#A80036" points="441.5,299.5859,431.5,303.5859,441.5,307.5859,437.5,303.5859" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="437.5" y="277.9536">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="283" x="450.5" y="270.3872">执行TerminateSessionAction的terminate方法</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="454.5" y="285.52"/><path d="M745,245.6875 L745,315.6875 L1322,315.6875 L1322,255.6875 L1312,245.6875 L745,245.6875 " fill="#FBFB77" filter="url(#fhxgr4n07kenp)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1312,245.6875 L1312,255.6875 L1322,255.6875 L1312,245.6875 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="751" y="262.7544">a:发送登出消息到客户端</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="556" x="751" y="277.8872">b:发送登出MQ信息（发送mq的作用是单点登录有时失效，乃补偿机制）；主题：topic.loginout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="751" y="293.02">c:deleteTicket(),执行删除TGT操作</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="184" x="751" y="308.1528">d:removeCookie，移除cookie</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="430.5" x2="472.5" y1="367.5508" y2="367.5508"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="472.5" x2="472.5" y1="367.5508" y2="380.5508"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="431.5" x2="472.5" y1="380.5508" y2="380.5508"/><polygon fill="#A80036" points="441.5,376.5508,431.5,380.5508,441.5,384.5508,437.5,380.5508" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="437.5" y="362.4849">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="260" x="450.5" y="362.4849">执行logoutAction的doInternalExecute方法</text><path d="M722,330.2188 L722,400.2188 L1129,400.2188 L1129,340.2188 L1119,330.2188 L722,330.2188 " fill="#FBFB77" filter="url(#fhxgr4n07kenp)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1119,330.2188 L1119,340.2188 L1129,340.2188 L1119,330.2188 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="386" x="728" y="347.2856">该方法主要是判断前面给cas客户端发出的登出消息请求是否成功，</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="260" x="728" y="362.4185">同时判断是否需要登出重定向到指定的地址，</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="366" x="728" y="377.5513">由于没有设置登出后需要重定向的地址，则service变量为null，</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="169" x="728" y="392.6841">直接返回FINISH_EVENT状态</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="430.5" x2="472.5" y1="452.082" y2="452.082"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="472.5" x2="472.5" y1="452.082" y2="465.082"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="431.5" x2="472.5" y1="465.082" y2="465.082"/><polygon fill="#A80036" points="441.5,461.082,431.5,465.082,441.5,469.082,437.5,465.082" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="437.5" y="447.0161">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="450.5" y="447.0161">跳转到finishLogout</text><path d="M578,414.75 L578,484.75 L1182,484.75 L1182,424.75 L1172,414.75 L578,414.75 " fill="#FBFB77" filter="url(#fhxgr4n07kenp)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1172,414.75 L1172,424.75 L1182,424.75 L1172,414.75 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="584" y="431.8169">&lt;decision-state id="finishLogout"&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="563" x="604" y="446.9497">&lt;if test="flowScope.logoutRedirectUrl != null" then="redirectView" else="logoutView" /&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="584" y="462.0825">&lt;/decision-state&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="322" x="588" y="477.2153">logoutRedirectUrl为null,不重定向，跳转到logoutView</text><polygon fill="#A80036" points="113.5,526.5469,103.5,530.5469,113.5,534.5469,109.5,530.5469" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="429.5" y1="530.5469" y2="530.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="119.5" y="517.9146">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="132.5" y="510.3481">第4步中，发送登出消息至客户端</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="132.5" y="525.481">cas server发送LogoutRequest请求到cas client</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="102.5" x2="144.5" y1="605.0781" y2="605.0781"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="144.5" x2="144.5" y1="605.0781" y2="618.0781"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="103.5" x2="144.5" y1="618.0781" y2="618.0781"/><polygon fill="#A80036" points="113.5,614.0781,103.5,618.0781,113.5,622.0781,109.5,618.0781" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="109.5" y="577.313">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="122.5" y="554.6138">CasSingleSignOutFilter</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="122.5" y="569.7466">根据ST查询session 并删除本地缓存的session</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="301" x="122.5" y="584.8794">存储类HashMapBackedSessionMappingStorage</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="122.5" y="600.0122">清除当前session的所有相关信息</text><path d="M175,631.0781 L175,701.0781 L682,701.0781 L682,641.0781 L672,631.0781 L175,631.0781 " fill="#FBFB77" filter="url(#fhxgr4n07kenp)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M672,631.0781 L672,641.0781 L682,641.0781 L672,631.0781 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="281" x="181" y="648.145">其中有业务系统需要获取登出MQ消息，作用是：</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="482" x="185" y="663.2778">在 UUM 点退出，默认是 UUM 退出了， SSO 退出了， 但业务系统可能没真正退出</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="468" x="181" y="678.4106">导致你点了退出后，直接访问业务系统的连接还是能正常访问（未成功单点退出）</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="181" y="693.5435">业务系统清空回话信息</text><!--
@startuml
Title: 登出流程\n
    autonumber
    浏览器 -> uum: 退出
    uum - -> uum: CasSingleSignOutFilter\n根据ST查询session 并删除本地缓存的session\n存储类HashMapBackedSessionMappingStorage\n清除当前session的所有相关信息
    uum -> sso:https:////sso.cn/logout?service=http:////uum.cn
    sso - -> sso: 执行TerminateSessionAction的terminate方法\n
    note right: a:发送登出消息到客户端\nb:发送登出MQ信息（发送mq的作用是单点登录有时失效，乃补偿机制）；主题：topic.loginout\nc:deleteTicket(),执行删除TGT操作\nd:removeCookie，移除cookie
    sso - -> sso: 执行logoutAction的doInternalExecute方法
    note right:该方法主要是判断前面给cas客户端发出的登出消息请求是否成功，\n同时判断是否需要登出重定向到指定的地址，\n由于没有设置登出后需要重定向的地址，则service变量为null，\n直接返回FINISH_EVENT状态
    sso - -> sso: 跳转到finishLogout
    note right:<decision-state id="finishLogout">\n     <if test="flowScope.logoutRedirectUrl != null" then="redirectView" else="logoutView" />\n</decision-state>\n logoutRedirectUrl为null,不重定向，跳转到logoutView
    sso -> uum:第4步中，发送登出消息至客户端\ncas server发送LogoutRequest请求到cas client
    uum - -> uum:CasSingleSignOutFilter\n根据ST查询session 并删除本地缓存的session\n存储类HashMapBackedSessionMappingStorage\n清除当前session的所有相关信息
    note over sso: 其中有业务系统需要获取登出MQ消息，作用是：\n 在 UUM 点退出，默认是 UUM 退出了， SSO 退出了， 但业务系统可能没真正退出\n导致你点了退出后，直接访问业务系统的连接还是能正常访问（未成功单点退出）\n业务系统清空回话信息
@enduml

PlantUML version 1.2019.08(Sat Jul 13 19:25:14 UTC 2019)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.7.0_25-b15
Operating System: Linux
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>